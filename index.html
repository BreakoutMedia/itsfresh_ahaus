<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Digital Signage Player</title>
<style>
  html,body{margin:0;padding:0;width:100%;height:100%;background:#000;}
  #container{width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:#000;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;font-size:40px;}
  video,img,iframe{max-width:100%;max-height:100%;width:100%;height:100%;object-fit:cover;border:none;background:#000;}
</style>
</head>
<body>
<div id="container">Lade…</div>
<script>
  const qs = new URLSearchParams(location.search);
  const screen = (qs.get('screen') || 'itsfresh').toLowerCase();

  // Manifest-Pfad: per ?manifest=… überschreibbar, sonst manifests/<screen>.json
  const baseURL = new URL('.', location.href);
  const manifestDefault = `manifests/${screen}.json`;
  const manifestOverride = qs.get('manifest');
  const manifestUrl = new URL(manifestOverride || manifestDefault, baseURL).toString();

  let playlist = [];
  let idx = 0;

  async function loadManifest(){
    try{
      const res = await fetch(manifestUrl + (manifestUrl.includes('?')?'&':'?') + 't=' + Date.now(), {cache:'no-store'});
      if(!res.ok) throw new Error('HTTP ' + res.status);
      const data = await res.json();
      const arr = Array.isArray(data.media) ? data.media : [];
      if(!arr.length) throw new Error('Manifest enthält keine Einträge (media[])');
      playlist = arr;
      return true;
    }catch(e){
      document.getElementById('container').textContent = 'Manifest nicht gefunden/leer:\n' + manifestUrl;
      console.error('[Manifest-Fehler]', e);
      return false;
    }
  }

  function showItem(item){
    const cont = document.getElementById('container');
    cont.innerHTML = '';
    let el;
    if(item.type === 'video'){
      el = document.createElement('video');
      el.src = item.src;
      el.autoplay = true;
      el.muted = true;
      el.playsInline = true;
      el.preload = 'auto';
      // Falls ein Video hängen bleibt, nach 6s weiter
      const guard = setTimeout(()=> next(), 6000);
      el.addEventListener('playing', ()=> clearTimeout(guard));
      el.addEventListener('error', ()=> next());
      el.addEventListener('stalled', ()=> next());
    }else if(item.type === 'image'){
      el = document.createElement('img');
      el.src = item.src;
    }else if(item.type === 'html'){
      el = document.createElement('iframe');
      el.src = item.src;
      el.sandbox = 'allow-scripts allow-same-origin';
    }else{
      el = document.createElement('div');
      el.textContent = 'Unbekannter Typ';
    }
    cont.appendChild(el);
  }

  function next(){
    idx = (idx + 1) % playlist.length;
    loop(); // direkt weiter
  }

  async function loop(){
    if(!playlist.length){
      document.getElementById('container').textContent = 'Keine Inhalte';
      return;
    }
    const item = playlist[idx % playlist.length];
    showItem(item);
    const durMs = Math.max(1, item.duration || 10) * 1000;
    setTimeout(()=>{
      // bei Rundenende Manifest frisch holen
      if((idx + 1) % playlist.length === 0){
        loadManifest().finally(next);
      }else{
        next();
      }
    }, durMs);
  }

  (async()=>{
    const ok = await loadManifest();
    if(ok) loop();
    // Fallback-Reload alle 5 Min
    setInterval(loadManifest, 5*60*1000);
  })();
</script>
</body>
</html>
